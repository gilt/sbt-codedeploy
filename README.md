# SBT plugin for [AWS CodeDeploy](http://aws.amazon.com/codedeploy/)

Creates zip files for usage with AWS CodeDeploy. Uses defaults that support conventions set forth in the AWS CodeDeploy docs.

[TODO: Add Build status once this is a public repo](https://magnum.travis-ci.com/gilt/sbt-codedeploy)

# WARNING
This plugin intereacts with AWS resources. You will be billed for the AWS resources used by using this plugin. 

# Installation

Add the following to your `project/plugins.sbt` file:

    resolvers += Resolver.sonatypeRepo("snapshot")

    addSbtPlugin("com.gilt" % "sbt-codedeploy" % "0.1-SNAPSHOT")

SBT CodeDeploy uses the AWS CodeDeploy API to upload the zip to a S3 Bucket. You must specify the bucket in your `build.sbt` or `Build.scala`:

    codedeployBucket in ThisBuild := "your-codedeploy-bucket-name-here"

## AWS Setup

It's expected that you have an AWS CodeDeploy Application already created and a DepoloymentGroup.

You'll also need to have AWS Credentials setup with enough privileges for the sbt-codedeploy to modify your AWS resources. These are some great resources for setting this is:
- [AWS CodeDeploy Getting Started](http://docs.aws.amazon.com/codedeploy/latest/userguide/getting-started-setup.html)
- [AWS CLI Credentials setup](http://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html)

# Conventions

sbt-codedeploy makes use of defaults conventions to make configuring your application easy. Though we find them useful, you may override them to fit your needs.

A simple project might have structure like this in addition to it's regular project files.

    /src/codedeploy/content/
    /src/codedeploy/scripts/ApplicationStop/
    /src/codedeploy/scripts/BeforeInstall/
    /src/codedeploy/scripts/AfterInstall/
    /src/codedeploy/scripts/ApplicationStart/
    /src/codedeploy/scripts/ValidateService/

## AppSpec File location

It's assumed that the appspec will be generated by the plugin unless a location is specified. The file will be placed in the root directory of the application's source content's directory structure. By default this is `/target/codedeploy/stage/appspec.yml`.

Default: None

Override: `codeDeployAppSpecLocation`

## Content

Content will be included from the current project and the build's classpath. The content will be put into the zip at `/target/codedeploy/stage/content/`.

Defaults:

- current project - `{baseDirectory}/src/codedeploy/content`
- classpath - `sbt/codedeploy/content`

Override:

- current project - `codeDeployContentDirectory`
- classpath - `codeDeployContentClasspath`

## Scripts

Scripts will be included from the current project and the build's classpath. The scripts will be put into the zip at `/target/codedeploy/stage/scripts/`.

The plugin is expecting scripts to be located in directories named after the hook they will be used with. If generating the appspec.yml the scripts will be run in an alphabetical ordering. We suggest putting numbers before the script name for easy ordering such as `200KillZombieChildren.sh` and `666InstallDaemons.sh` which would run in that order.

    scripts/ApplicationStop/
    scripts/BeforeInstall/
    scripts/AfterInstall/
    scripts/ApplicationStart/
    scripts/ValidateService/

Defaults:

- current project - `{baseDirectory}/src/codedeploy/scripts`
- classpath - `sbt/codedeploy/scripts`

Override:

- current project - `codeDeployScriptsDirectory`
- classpath - `codeDeployScriptsClasspath`

## Application Name

The default value is the project's name.

Override like this:

    name in CodeDeploy := "new-better-shinier-name"

## AWS Profile

The AWS profile that will be used to when making AWS API calls.

Default: "default"

Override: `codeDeployAwsProfile`

## Deployment IgnoreApplicationStopFailures

This is a setting used during deployments. It's documented in AWS's CodeDeploy docs here: [DeploymentInfo IgnoreApplicationStopFailures(http://docs.aws.amazon.com/codedeploy/latest/APIReference/API_DeploymentInfo.html#-Type-DeploymentInfo-IgnoreApplicationStopFailures)]

Default: false

Override: `codeDeployIgnoreApplicationStopFailures`

# Usage

## Create Deployment

To create a deployment the `codeDeployCreateDeployment` task needs the name of the CodeDeploy DeploymentGroup to deploy to. It will push a zip and then start the deployment.

    sbt “codeDeploy:codeDeployCreateDeployment test”

You may want to create a new alias such as `deploy-test` to clean up the verbose syntax for your specific use case.

**This call does not block for the deployment to finish.**

## Push

If you just want to create the zip and push it to your configured S3 bucket use this.

    sbt codeDeploy:publish

# Advanced Overriding

## Native Packager

sbt-codedeploy uses sbt-native-packager and you will need to understand it's usage to modify some of these advanced features.

See [sbt-native-packager-example](sbt-native-packager-example/README.md) for an example of how to use with sbt-native-packager.

## Content Mappings

If the default content mappings above are not enough you can override them. For example, maybe there is content in multiple places of the classpath that you would like included instead of the one place specified by `codeDeployContentClasspath`, you can override: `codeDeployContentMappings`.

## Script Mappings

If the default script mappings above are not enough you can override them. For example, maybe there are scripts in multiple places of the classpath that you would like included instead of the one place specified by `codeDeployScriptClasspath`, you can override: `codeDeployScriptMappings`.

# FAQ

## My artifacts that should be included through the classpath are not being found. Why is this?

Check that your dependecies which include your artifacts are on your build's classpath, not your projects. They need to be visible to the plugin and are not related to the runtime dependencies.